FROM resin/%%RESIN_MACHINE_NAME%%-alpine:latest

RUN apk add --no-cache \
    dcron \
	rsnapshot \
	openssh-client \
	curl \
	samba \
    samba-common-tools \
    supervisor

# install root filesystem overlay
COPY /root /

RUN cp /config/ssh_config /etc/ssh/ssh_config

RUN cp /config/cron.conf /var/spool/cron/crontabs/root

# set a simple samba password for the root user
RUN /bin/echo -e "resin\nresin" | smbpasswd -a -s -c /config/smb.conf root

WORKDIR /usr/src/app

COPY /app ./

RUN curl -sL https://raw.githubusercontent.com/rsnapshot/rsnapshot/master/utils/backup_smb_share.sh > backup_smb_share.sh.example

CMD ["/bin/bash", "/usr/local/bin/start.sh"]
